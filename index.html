<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç·Šæ€¥åœ°éœ‡é€Ÿå ±ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼v1.9.13</title>
<style>
body {
  font-family:"Yu Gothic","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
  white-space: pre-wrap;
  margin: 5px;
  padding: 5px;
  background: #fff;
  font-size: 14px;
  line-height: 1.4;
}
#eew { 
  margin: 0; 
  padding: 0; 
  font-family:"Yu Gothic","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
}
#status { 
  font-size: 12px; 
  margin-bottom: 0px; 
}
#copyBtn {
  font-size: 12px;
  padding: 2px 5px;
  margin-bottom: 0px;
  cursor: pointer;
}
</style>
</head>
<body>
<div id="status">æ›´æ–°ä¸­...</div>
<button id="copyBtn">æœ¬æ–‡ã‚’ã‚³ãƒ”ãƒ¼</button>
<pre id="eew">èª­ã¿è¾¼ã¿ä¸­...</pre>

<script>
// åœ°æ–¹ â‡” è©³ç´°åœ°åŸŸ å¯¾å¿œè¡¨ï¼ˆå®Œå…¨ç‰ˆï¼‰
const regionMap = {
  "é“å¤®": ["çŸ³ç‹©", "å¾Œå¿—", "ç©ºçŸ¥"],
  "é“å—": ["æ¸¡å³¶", "æªœå±±", "å¥¥å°»å³¶", "èƒ†æŒ¯", "æ—¥é«˜"],
  "é“åŒ—": ["ä¸Šå·", "ç•™èŒ", "å®—è°·", "åˆ©å°»ç¤¼æ–‡"],
  "é“æ±": ["ç¶²èµ°", "åŒ—è¦‹", "ç´‹åˆ¥", "åå‹", "é‡§è·¯", "æ ¹å®¤"],
  "é’æ£®": ["é’æ£®"],
  "å²©æ‰‹": ["å²©æ‰‹"],
  "å®®åŸ": ["å®®åŸ"],
  "ç§‹ç”°": ["ç§‹ç”°"],
  "å±±å½¢": ["å±±å½¢"],
  "ç¦å³¶": ["ç¦å³¶"],
  "èŒ¨åŸ": ["èŒ¨åŸ"],
  "æ ƒæœ¨": ["æ ƒæœ¨"],
  "ç¾¤é¦¬": ["ç¾¤é¦¬"],
  "åŸ¼ç‰": ["åŸ¼ç‰"],
  "åƒè‘‰": ["åƒè‘‰"],
  "æ±äº¬": ["æ±äº¬"],
  "ä¼Šè±†è«¸å³¶": ["ä¼Šè±†å¤§å³¶", "æ–°å³¶", "ç¥æ´¥å³¶", "ä¸‰å®…å³¶", "å…«ä¸ˆå³¶"],
  "å°ç¬ åŸ": ["å°ç¬ åŸ"],
  "ç¥å¥ˆå·": ["ç¥å¥ˆå·"],
  "æ–°æ½Ÿ": ["æ–°æ½Ÿ", "ä½æ¸¡"],
  "å¯Œå±±": ["å¯Œå±±"],
  "çŸ³å·": ["çŸ³å·"],
  "ç¦äº•": ["ç¦äº•"],
  "å±±æ¢¨": ["å±±æ¢¨"],
  "é•·é‡": ["é•·é‡"],
  "å²é˜œ": ["å²é˜œ"],
  "é™å²¡": ["é™å²¡"],
  "æ„›çŸ¥": ["æ„›çŸ¥"],
  "ä¸‰é‡": ["ä¸‰é‡"],
  "æ»‹è³€": ["æ»‹è³€"],
  "äº¬éƒ½": ["äº¬éƒ½"],
  "å¤§é˜ª": ["å¤§é˜ª"],
  "å…µåº«": ["å…µåº«", "æ·¡è·¯å³¶"],
  "å¥ˆè‰¯": ["å¥ˆè‰¯"],
  "å’Œæ­Œå±±": ["å’Œæ­Œå±±"],
  "é³¥å–": ["é³¥å–"],
  "å³¶æ ¹": ["å³¶æ ¹", "éš å²"],
  "å²¡å±±": ["å²¡å±±"],
  "åºƒå³¶": ["åºƒå³¶"],
  "å±±å£": ["å±±å£"],
  "å¾³å³¶": ["å¾³å³¶"],
  "é¦™å·": ["é¦™å·"],
  "æ„›åª›": ["æ„›åª›"],
  "é«˜çŸ¥": ["é«˜çŸ¥"],
  "ç¦å²¡": ["ç¦å²¡"],
  "ä½è³€": ["ä½è³€"],
  "é•·å´": ["é•·å´"],
  "ç†Šæœ¬": ["ç†Šæœ¬"],
  "å¤§åˆ†": ["å¤§åˆ†"],
  "å®®å´": ["å®®å´"],
  "é¹¿å…å³¶": ["è–©æ‘©", "å¤§éšˆ", "åå³¶æ‘", "ç”‘å³¶", "ç¨®å­å³¶", "å±‹ä¹…å³¶"],
  "å¥„ç¾ç¾¤å³¶": ["å¥„ç¾"],
  "æ²–ç¸„æœ¬å³¶": ["æ²–ç¸„æœ¬å³¶", "ä¹…ç±³å³¶"],
  "å¤§æ±å³¶": ["å¤§æ±å³¶"],
  "å®®å¤å³¶": ["å®®å¤å³¶"],
  "å…«é‡å±±": ["çŸ³å£å³¶", "ä¸é‚£å›½å³¶", "è¥¿è¡¨å³¶"]
};

const outputEl = document.getElementById("eew");
const statusEl = document.getElementById("status");
const copyBtn = document.getElementById("copyBtn");

async function updateEEW() {
  try {
    const res = await fetch("https://api.wolfx.jp/jma_eew.json");
    //const res = await fetch("https://script.google.com/macros/s/AKfycbzgP8R7vowRFrefHbUIkAcGt4NFjJZcuVnnpVqIjpprlCA44PtTk7ffHs-f4HP8Yk8A/exec");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    let eewMessage = "";
    let eewNotice = "";

    if (data.isTraining) {
      outputEl.textContent = "è¨“ç·´å ±ã®ãŸã‚å‡¦ç†çµ‚äº†";
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,'0');
      const d = String(now.getDate()).padStart(2,'0');
      const h = String(now.getHours()).padStart(2,'0');
      const min = String(now.getMinutes()).padStart(2,'0');
      const s = String(now.getSeconds()).padStart(2,'0');
      statusEl.textContent = `æœ€çµ‚æ›´æ–°: ${y}/${m}/${d} ${h}:${min}:${s}`;
      return;
    }

    let maxInt = data.MaxIntensity;
    const isWarn = data.isWarn;
    let coloredTitle = data.Title;

    if (["1","2"].includes(maxInt)) {
      coloredTitle = isWarn ? `ğŸŸ¥${data.Title}ğŸŸ¥` : `ğŸŸ¦${data.Title}ğŸŸ¦`;
    } else if (["3","4"].includes(maxInt)) {
      coloredTitle = isWarn ? `ğŸŸ¥${data.Title}ğŸŸ¥` : `ğŸŸ¨${data.Title}ğŸŸ¨`;
    } else if (["5-","5+","5å¼±","5å¼·"].includes(maxInt)) {
      coloredTitle = `ğŸŸ¥${data.Title}ğŸŸ¥`;
      eewNotice += `ï¼Šã€€ï¼Šã€€ï¼Š
ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã§ã™ã€‚éœ‡åº¦${maxInt}ã®å¼·ã„æºã‚Œã«è­¦æˆ’ã—ã¦ãã ã•ã„ã€‚
é ­ã‚’å®ˆã‚‹ãªã©ã—ã¦ã€ãŸã ã¡ã«èº«ã®å®‰å…¨ã‚’ç¢ºä¿ã—ã¦ãã ã•ã„ã€‚
å€’ã‚Œã‚„ã™ã„ã‚‚ã®ãªã©ã‹ã‚‰ã¯é›¢ã‚Œã¦ãã ã•ã„ã€‚`;
    } else if (["6-","6å¼±","6+","6å¼·","7"].includes(maxInt)) {
      coloredTitle = `ğŸŸª${data.Title}ğŸŸª`;
      let maxIntEn = "";
      if (maxInt === "6å¼±") maxIntEn = "6 lower";
      else if (maxInt === "6å¼·") maxIntEn = "6 upper";
      else maxIntEn = maxInt;
      eewNotice += `ï¼Šã€€ï¼Šã€€ï¼Š
ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã§ã™ã€‚éœ‡åº¦${maxInt}ã®éå¸¸ã«å¼·ã„æºã‚Œã«è­¦æˆ’ã—ã¦ãã ã•ã„ã€‚
ãŸã ã¡ã«èº«ã®å®‰å…¨ã‚’ç¢ºä¿ã—ã¦ãã ã•ã„ã€‚é ­ã‚’å®ˆã£ã¦ãã ã•ã„ã€‚
å€’ã‚Œã‚„ã™ã„ã‚‚ã®ãªã©ã‹ã‚‰ã¯é›¢ã‚Œã¦ãã ã•ã„ã€‚
ã¾ãŸã€éœ‡æºãŒæµ·åº•ã®å ´åˆã¯æ´¥æ³¢ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
æ²¿å²¸éƒ¨ã§ã¯ã€å¿µã®ãŸã‚æ´¥æ³¢ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
ï¼ï¼ï¼
Earthquake Early Warning. Very strong shaking of intensity ${maxIntEn} is expected. Take immediate action to protect yourself.`;
    } else {
      coloredTitle = `ã€Š${data.Title}ã€‹`;
      maxInt = "ä¸æ˜"
      eewNotice += `ï¼Šã€€ï¼Šã€€ï¼Š
ä»Šå¾Œã®æƒ…å ±ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚`;
    }

    eewMessage += coloredTitle;

    const serialText = data.isFinal ? `# ç¬¬${data.Serial}(æœ€çµ‚)å ±` : `# ç¬¬${data.Serial}å ±`;
    document.body.style.background = data.isFinal ? "#ffffff" : "#f3cccb";
    eewMessage += `\n${serialText}\n`;

    if (data.isCancel) {
      const hypocenter = data.Hypocenter ?? "éœ‡æºåœ°ä¸æ˜";
      const tz = "Asia/Tokyo";
      const announceDate = data.AnnouncedTime ? new Date(data.AnnouncedTime) : null;
      const announceStr = announceDate
        ? `${String(announceDate.getDate()).padStart(2,'0')}æ—¥${String(announceDate.getHours()).padStart(2,'0')}:${String(announceDate.getMinutes()).padStart(2,'0')}:${String(announceDate.getSeconds()).padStart(2,'0')}`
        : "ç™ºè¡¨æ™‚åˆ»ä¸æ˜";

      eewMessage += `\nã“ã®ç·Šæ€¥åœ°éœ‡é€Ÿå ±${hypocenter ? `ï¼ˆ${hypocenter}ï¼‰` : ""}ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚\n\n${announceStr}ã€€æ°—è±¡åºç™ºè¡¨`;
      eewNotice = ""

      outputEl.textContent = eewMessage + (eewNotice ? "\n" + eewNotice : "");
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,'0');
      const d = String(now.getDate()).padStart(2,'0');
      const h = String(now.getHours()).padStart(2,'0');
      const min = String(now.getMinutes()).padStart(2,'0');
      const s = String(now.getSeconds()).padStart(2,'0');
      statusEl.textContent = `æœ€çµ‚æ›´æ–°: ${y}/${m}/${d} ${h}:${min}:${s}`;
      return;
    }

    if (data.isAssumption) {
      const hypocenter = data.Hypocenter ?? "éœ‡æºåœ°ä¸æ˜";
      eewMessage += `
PLUMæ³•ã«ã‚ˆã‚‹ç·Šæ€¥åœ°éœ‡é€Ÿå ±
${hypocenter} ã§æºã‚Œ
æ¨å®šæœ€å¤§éœ‡åº¦ ${maxInt}`;
    } else {
      const hypocenter = data.Hypocenter ?? "éœ‡æºåœ°ä¸æ˜";
      const magnitude = (data.Magunitude != null) ? Number(data.Magunitude).toFixed(1) : "ä¸æ˜";
      const depth = data.Depth ?? "ä¸æ˜";
      eewMessage += `
${hypocenter} ã§åœ°éœ‡
æ¨å®šæœ€å¤§éœ‡åº¦ ${maxInt}
M${magnitude}
éœ‡æºã®æ·±ã•:${depth}km`;
    }

      if (data.WarnArea && data.WarnArea.length > 0) {
      
        // â–¼ å¯¾è±¡åœ°åŸŸï¼ˆè©³ç´°ï¼‰ï¼šå…ƒãƒ‡ãƒ¼ã‚¿é † + äºˆæƒ³éœ‡åº¦
        const detailList = data.WarnArea.map(a => {
          const shindo = a.Shindo1 ?? "ä¸æ˜";
          return `${a.Chiiki} [${shindo}]`;
        });
      
        // â–¼ å¯¾è±¡åœ°åŸŸï¼ˆåœ°æ–¹ï¼‰æŠ½å‡º
        const regionSet = new Set();
      
        for (const { Chiiki } of data.WarnArea) {
          for (const [region, areas] of Object.entries(regionMap)) {
            if (areas.some(area => Chiiki.includes(area))) {
              regionSet.add(region);
            }
          }
        }
      
        // â–¼ åœ°æ–¹ã®è¡¨ç¤ºé †ï¼ˆå›ºå®šï¼‰
        const regionOrder = [
          "é“åŒ—","é“å¤®","é“å—","é“æ±",
          "é’æ£®","å²©æ‰‹","å®®åŸ","ç§‹ç”°","å±±å½¢","ç¦å³¶",
          "èŒ¨åŸ","æ ƒæœ¨","ç¾¤é¦¬","åŸ¼ç‰","åƒè‘‰","æ±äº¬","ä¼Šè±†è«¸å³¶","å°ç¬ åŸ","ç¥å¥ˆå·",
          "æ–°æ½Ÿ","å¯Œå±±","çŸ³å·","ç¦äº•","å±±æ¢¨","é•·é‡",
          "å²é˜œ","é™å²¡","æ„›çŸ¥","ä¸‰é‡",
          "æ»‹è³€","äº¬éƒ½","å¤§é˜ª","å…µåº«","å¥ˆè‰¯","å’Œæ­Œå±±",
          "é³¥å–","å³¶æ ¹","å²¡å±±","åºƒå³¶","å±±å£",
          "å¾³å³¶","é¦™å·","æ„›åª›","é«˜çŸ¥",
          "ç¦å²¡","ä½è³€","é•·å´","ç†Šæœ¬","å¤§åˆ†","å®®å´","é¹¿å…å³¶",
          "å¥„ç¾ç¾¤å³¶","æ²–ç¸„æœ¬å³¶","å¤§æ±å³¶","å®®å¤å³¶","å…«é‡å±±"
        ];
      
        const sortedRegions = regionOrder.filter(r => regionSet.has(r));
      
        // â–¼ å‡ºåŠ›
        eewMessage += `\n\nã€å¯¾è±¡åœ°åŸŸ(åœ°æ–¹)ã€‘\n${sortedRegions.join("ã€")}`;
        eewMessage += `\n\nã€å¯¾è±¡åœ°åŸŸ(è©³ç´°)[äºˆæƒ³éœ‡åº¦]ã€‘\n${detailList.join("\n")}`;
      }

    const tz = "Asia/Tokyo";
    const originStr = data.OriginTime
      ? (() => {
          const d = new Date(data.OriginTime);
          const yyyy = d.getFullYear();
          const MM = String(d.getMonth() + 1).padStart(2, '0');
          const dd = String(d.getDate()).padStart(2, '0');
          const HH = String(d.getHours()).padStart(2, '0');
          const mm = String(d.getMinutes()).padStart(2, '0');
          const ss = String(d.getSeconds()).padStart(2, '0');
          return `${yyyy}/${MM}/${dd} ${HH}:${mm}:${ss}`;
        })()
      : "ç™ºç”Ÿæ™‚åˆ»ä¸æ˜";
    const announceDate = data.AnnouncedTime ? new Date(data.AnnouncedTime) : null;
    const announceStr = announceDate
      ? `${String(announceDate.getDate()).padStart(2,'0')}æ—¥${String(announceDate.getHours()).padStart(2,'0')}:${String(announceDate.getMinutes()).padStart(2,'0')}:${String(announceDate.getSeconds()).padStart(2,'0')}`
      : "ç™ºè¡¨æ™‚åˆ»ä¸æ˜";
    
    eewMessage += `\n\n${originStr}ç™ºç”Ÿ`;
    eewMessage += `\n${announceStr} æ°—è±¡åºç™ºè¡¨`;

    if (eewNotice===""){
      outputEl.textContent = eewMessage;
    } else {
      outputEl.textContent = eewMessage + "\n" + eewNotice;
    }

    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    const h = String(now.getHours()).padStart(2,'0');
    const min = String(now.getMinutes()).padStart(2,'0');
    const s = String(now.getSeconds()).padStart(2,'0');
    statusEl.textContent = `æœ€çµ‚æ›´æ–°: ${y}/${m}/${d} ${h}:${min}:${s}`;
    
  } catch(e) {
    outputEl.textContent = "å–å¾—ã‚¨ãƒ©ãƒ¼: " + e.message + (e.stack ? "\n" + e.stack : "");
  }
}

updateEEW();
setInterval(updateEEW, 2000);

// ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
copyBtn.addEventListener("click", () => {
  const text = outputEl.textContent;
  navigator.clipboard.writeText(text).then(() => {
    const originalText = copyBtn.textContent;
    copyBtn.textContent = "ã‚³ãƒ”ãƒ¼å®Œäº†";
    setTimeout(() => { 
      copyBtn.textContent = originalText;
    }, 1500);
  }).catch(err => {
    alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
  });
});
</script>
</body>
</html>
